!function($){var itemEditer,viewerData=function(){var data=null,orderBy="",orderType="asc",page="1",vid="",filter=[],iofunc={},makeIOfunc=function(script){return eval('(function(js){if(js===""||js===undefined){return {in:function(data){return data}, out:function(data){return data}}}else{return js}})('+script+")")},initIO=function(a){var b,c;for(b in a)c=atob(a[b]),iofunc[b]=makeIOfunc(c)},io=function(a){return iofunc[a]},getInfo=function(){return null==data?null:data["info"]},getMap=function(){return null==data?null:data["info"]["map"]},getFields=function(){return null==data?null:data["info"]["fields"]},primaryKey=function(){return data["info"]["primaryKey"]},primaryName=function(){return data["info"]["primaryName"]},getVid=function(){return vid},get=function(a,b){a!==vid&&(orderBy="",orderType="asc"),void 0===b&&(b=[]),$.ajax({url:"/api/viewerdata?viewer-id="+a+"&limit=20+"+"&order="+orderBy+"&order-type="+orderType+"&page=1"+"&filter="+JSON.stringify(b),method:"GET",async:"true",cache:"false",success:function(c){data=c,vid!=a&&(iofunc={},initIO(data["info"]["script"]),vid=a),page=data["pages"]["current"],filter=b,""===orderBy&&(orderBy=data["info"]["primaryKey"]),drawOperator(),drawPagebar(),drawTable(),0!==filter.length?$("#clear-filter").removeClass("invisible"):$("#clear-filter").addClass("invisible")},error:function(a){message(a.responseJSON.msg,"danger")}})},getPage=function(a){$.ajax({url:"/api/viewerdata?viewer-id="+vid+"&limit=20+"+"&order="+orderBy+"&order-type="+orderType+"&page="+a+"&filter="+JSON.stringify(filter),method:"GET",async:"true",cache:"false",success:function(a){data=a,page=data["pages"]["current"],drawOperator(),drawPagebar(),drawTable(),0!==filter.length?$("#clear-filter").removeClass("invisible"):$("#clear-filter").addClass("invisible")},error:function(a){message(a.responseJSON.msg,"danger")}})},clearFilter=function(){filter=[];var a=$("#viewer-data-searcher form");a.attr("vid",""),get(vid)},flush=function(){getPage(page)},drawOperator=function(){var b,c,d,e,f,a=$(".table-operator");a.html(""),b=$('<button type="button" class="btn btn-danger" id="data-deleter">删除</button>'),c=$('<button type="button" class="btn btn-primary" id="data-adder">添加</button>'),c.css("margin-left","5px"),d=$('<button class="btn btn-primary" id="data-searcher">搜索</button>'),d.css("margin-left","5px"),e=$('<button class="btn btn-primary invisible" id="clear-filter">清除过滤</button>'),e.css("margin-left","5px"),f=$('<ul class="float-sm-right pagination pagination-sm" id="page-bar"></ul>'),f.css("margin-left","5px"),c.click(function(){var a,b,c,d;if("1"===$.viewerData.getVid())a=$("#menu-item-editer"),a.find(".modal-title").html("添加菜单项"),a.find(".ensure").attr("action","add"),a.modal();else if("2"===$.viewerData.getVid())a=$("#viewer-item-editer"),a.find(".modal-title").html("添加视图项"),a.find(".ensure").attr("action","add"),a.modal();else{if(b=$.viewerData.getFields(),null==b)return;for(c=[],d=0;d<b.length;d++)c.push(b[d]["name"]);$.itemEditer.creater(c)}}),b.click(function(){var c,d,e,f,g,a=[],b=$(".row-checker");for(c=0;c<b.length;c++)d=$(b[c]),d.is(":checked")&&(e=d.parent().parent(),f=e.children('td[col="'+$.viewerData.primaryName()+'"]'),g=f.children("span"),a.push($.viewerData.io($.viewerData.primaryName()).out(g.html()).toString()));$.ajax({url:"/api/viewerdata?param="+JSON.stringify(a)+"&viewer-id="+$.viewerData.getVid(),method:"DELETE",sync:"false",cache:"false",success:function(){message("删除成功","success"),$.viewerData.flush()},error:function(a){message(a.responseJSON.msg,"danger")}})}),d.click(function(){var a=$.viewerData.getInfo();null!=a&&$.itemEditer.searcher(a)}),e.click(function(){$.viewerData.clearFilter()}),a.append(b),a.append(c),a.append(d),a.append(e),a.append(f)},drawPagebar=function(){var a,b,c,d,e,f;if(null!=data){a=$("#page-bar"),a.html(""),b=data["pages"],null!=b["first"]&&(c=$('<li class="page-item"><a class="page-link page-num" href="#" page="1">首页</a></li>'),a.append(c)),null!=b["prev"]&&(c=$('<li class="page-item"><a class="page-link page-num" href="#" page="'+b["prev"]+'">'+"<上一页</a></li>"),a.append(c)),d=b["pages"];for(e in d)c=$('<li class="page-item"><a class="page-link page-num" href="#" page="'+d[e]+'">'+d[e]+"</a></li>"),d[e]===b["current"]&&c.addClass("active"),a.append(c);null!=b["total"]&&(c=$('<li class="page-item"><a class="page-link page-num" href="#" page="'+b["total"]+'">'+"..."+b["total"]+"</a></li>"),a.append(c)),null!=b["next"]&&(c=$('<li class="page-item"><a class="page-link page-num" href="#" page="'+b["next"]+'">'+"下一页></a></li>"),a.append(c)),null!=b["last"]&&(c=$('<li class="page-item"><a class="page-link page-num" href="#" page="'+b["last"]+'">'+"尾页</a></li>"),a.append(c)),f=$("#page-bar a"),f.click(function(){var a=$(this).attr("page");getPage(a)})}},drawTable=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m;if(null!=data){a=$("#main-table"),a.html(""),b=$('<thead  class="bg-warning"></thead>'),c=$("<tr></tr>"),d=$('<td><input type="checkbox" id="table-checkbox"></td>'),c.append(d),e=data.info.fields;for(f in e)g="",e[f]["order"]===!0&&(h="▲","desc"===orderType&&(h="▼"),g=e[f]["field"]===orderBy?'<span class="text-primary">'+h+"</span>":h),d=$('<td name="'+e[f]["field"]+'">'+e[f]["name"]+g+"</td>"),e[f]["order"]===!0&&(d.addClass("can-sort"),d.css("cursor","pointer"),d.click(function(){var a=$(this).attr("name");a===orderBy?orderType="asc"===orderType?"desc":"asc":orderBy=a,flush()})),c.append(d);for(("1"===vid||"2"===vid)&&(d=$("<td></td>"),c.append(d)),b.append(c),a.append(b),i=$("<tbody></tbody>"),j=data.data,k=0;k<j.length;k++){c=$("<tr></tr>"),d=$('<td><input class="row-checker" type="checkbox"></td>'),c.append(d);for(f in e)d=$('<td col="'+e[f]["name"]+'">'+'<span class="td-content">'+$.viewerData.io(e[f]["name"]).in(j[k][f])+"</span>"+"</td>"),l=d.children("span"),l.css("cursor","pointer"),l.click(function(){var a=$(this).parent(),b=a.parent(),c=a.attr("col"),d=$(this).html(),e=b.children('td[col="'+$.viewerData.primaryName()+'"]'),f=e.children("span").html(),g={key:c,value:d,primary:f};$.itemEditer.editer(g),$("#viewer-data-editer").modal()}),c.append(d);("1"===vid||"2"===vid)&&(m=$('<button type="button" class="btn btn-primary btn-sm">编辑</button>'),"1"===vid?m.click(function(){var a=$("#menu-item-editer"),b=a.find("form"),c=$(this).parent().parent(),d=c.children('td[col="菜单名"]').children("span").html(),e=c.children('td[col="访问者"]').children("span").html(),f=b.children('input[name="item-name"]'),g=b.children('input[name="allow"]'),h=c.children('td[col="菜单ID"]').children("span").html();f.val(d),g.val(e),a.find(".modal-title").html("编辑菜单项"),a.find(".ensure").attr("action","update"),a.find(".ensure").attr("menu-id",h),a.modal()}):"2"===vid&&m.click(function(){var s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,a=$("#viewer-item-editer"),b=$("#viewer-base-info"),c=$(this).parent().parent(),d=b.children('input[name="item-name"]'),e=b.children('input[name="allow"]'),f=$("#viewer-item-editer .sql-config"),g=f.find('input[name="address"]'),h=f.find('input[name="password"]'),i=f.find('input[name="database"]'),j=f.find('input[name="table"]'),k=f.find('input[name="user"]'),l=c.children('td[col="视图名"]').children("span").html(),m=c.children('td[col="访问者"]').children("span").html(),n=c.children('td[col="数据库地址"]').children("span").html(),o=c.children('td[col="数据库密码"]').children("span").html(),p=c.children('td[col="数据库名"]').children("span").html(),q=c.children('td[col="表名"]').children("span").html(),r=c.children('td[col="数据库用户"]').children("span").html();d.val(l),e.val(m),g.val(n),h.val(o),i.val(p),j.val(q),k.val(r),s=$.func.getFormData($("#viewer-item-editer .sql-config")),$.ajax({url:"/api/databaseField?"+s,method:"GET",async:!1,cache:!1,success:function(a){$.dbFields.clear(),$.dbFields.set(a),$("#sql-check-result").removeClass("text-danger"),$("#sql-check-result").addClass("text-success"),$("#sql-check-result").text("检查数据库成功")},error:function(a){$.dbFields.clear(),$("#sql-check-result").removeClass("text-success"),$("#sql-check-result").addClass("text-danger"),$("#sql-check-result").text(a.responseJSON.msg)}});try{for(t=JSON.parse(c.children('td[col="字段信息"]').children("span").html()),u=t["fields"],v=$.dbFields.get(),w="",x=0;x<v.length;x++)w=w+"<option>"+v[x]["name"]+"</option>";for(y=$("#viewer-item-editer .viewer-fields"),x=0;x<u.length;x++)z=$('<div class="form-group form-inline viewer-field alert"><label>字段名：</label></div>'),d=$('<input type="text" name="field-name">'),d.val(u[x]["name"]),A=$('<select class="custom-select custom-select-sm">'+w+"</select>"),A.val(u[x]["field"]),B=$('<input type="checkbox" class="form-check-input" name="can-order" value="">'),u[x]["order"]===!0&&B.prop("checked",!0),C=$('<input type="radio" name="primary-key">'),u[x]["name"]===t["primaryName"]&&C.prop("checked",!0),D=randomString(8,"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"),E=$('<button type="button" class="btn btn-primary btn-sm" name="script-creater" script-id="'+D+'" data-toggle="modal" data-target="#viewer-data-script-editer">脚本</button>'),E.click(function(){var c,a=$(this).attr("script-id"),b=$("#viewer-data-script-editer textarea");b.attr("script-id",a),c=$("#"+a).val(),b.val(c)}),F=$('<textarea class="d-none" name="script-container" id="'+D+'"></textarea>'),G=atob(t["script"][u[x]["name"]]),F.val(G),""!==G&&(E.removeClass("btn-primary"),E.addClass("btn-danger")),H=$('<button type="button" class="close" data-dismiss="alert">&times;</button>'),z.append(d),z.append(A),z.append(B),z.append("可排序"),z.append(C),z.append("主键"),z.append(E),z.append(F),z.append(H),y.append(z);I=c.children('td[col="视图ID"]').children("span").html(),a.find(".modal-title").html("编辑视图项"),a.find(".ensure").attr("action","update"),a.find(".ensure").attr("viewer-id",I)}catch(J){message(J.message,"danger")}finally{a.modal()}}),d=$("<td></td>"),d.append(m),c.append(d)),i.append(c)}a.append(i),$("#table-checkbox").change(function(){$(this).is(":checked")?$('#main-table input[type="checkbox"]').prop("checked",!0):$('#main-table input[type="checkbox"]').prop("checked",!1)})}};return{get:get,getPage:getPage,drawOperator:drawOperator,drawPagebar:drawPagebar,drawTable:drawTable,primaryKey:primaryKey,primaryName:primaryName,getVid:getVid,getMap:getMap,getFields:getFields,getInfo:getInfo,flush:flush,clearFilter:clearFilter,io:io}};$.extend({viewerData:viewerData()}),itemEditer=function(){var a=function(a){var d,b=$("#viewer-data-editer .header-title"),c=$("#viewer-data-editer .modal-body");b.html(a["key"]),d=$('<textarea class="form-control" rows="1" field="'+a["key"]+'"'+'primary="'+a["primary"]+'"'+">"+a["value"]+"</textarea>"),d.on("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"}),c.append(d)},b=function(a){var d,e,f,g,h,i,j,k,l,b=$("#viewer-data-creater form"),c=$.viewerData.getInfo();for(d=0;d<a.length;d++)e=c["default"][a[d]],f=c["nullable"][a[d]],g=c["extra"][a[d]],h='   <small class="text-secondary">默认('+e+")"+"</small>","auto_increment"===g&&(h="   <small>默认(自增)</small>"),i=$('<div class="form-group"></div>'),j=$("<label>"+a[d]+h+"</label>"),k=$('<textarea class="form-control" rows="1" field="'+a[d]+'"'+">"+"</textarea>"),null==e&&"NO"===f&&"auto_increment"!==g&&k.addClass("is-invalid"),k.on("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"}),i.append(j),i.append(k),"auto_increment"===g&&(l=$("<fieldset disabled></fieldset>"),i=l.append(i)),b.append(i);$("#viewer-data-creater").modal()},c=function(a){var e,f,g,h,i,j,k,b=a["fields"],c=$("#viewer-data-searcher form"),d=c.attr("vid");if(d!==$.viewerData.getVid())for(c.html(""),c.attr("vid",$.viewerData.getVid()),e=0;e<b.length;e++)f=b[e]["name"],g=b[e]["field"],h=$('<div class="form-group"></div>'),i=$("<label>"+f+"</label>"),j=$("<select><option>=</option><option>&gt</option><option>&lt</option></select>"),k=$('<textarea class="form-control" rows="1" name="'+f+'" field="'+g+'"'+">"+"</textarea>"),k.on("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"}),h.append(i),h.append(j),h.append(k),c.append(h);$("#viewer-data-searcher").modal()};return{editer:a,creater:b,searcher:c}},$.extend({itemEditer:itemEditer()})}(jQuery),function(a){var d,e,f,g,h,i,j,k,b=function(b){var f,g,h,i,j,k,l,m,c=a.dbFields.get(),d={primaryName:null,primaryKey:null,fields:[],map:{},"default":{},nullable:{},extra:{},script:{}},e=b.children(".viewer-field");for(f=0;f<e.length;f++)if(g=a(e[f]).children('input[name="field-name"]').val(),""!==g){if(d["map"].hasOwnProperty(g))return[null,"字段名重复"];for(h=a(e[f]).children("select").val(),i=a(e[f]).children('input[name="can-order"]').is(":checked"),j=a(e[f]).children('input:radio[name="primary-key"]').is(":checked"),j&&(d.primaryName=g,d.primaryKey=h),d["fields"].push({name:g,field:h,order:i}),d["map"][g]=h,k=0;k<c.length;k++)if(c[k]["name"]===h){d["default"][g]=c[k]["default"],d["nullable"][g]=c[k]["nullable"],d["extra"][g]=c[k]["extra"];break}l=a(e[f]).children('textarea[name="script-container"]'),m=l.val(),m=btoa(m),d["script"][g]=m}return[d,null]},c=function(){var a;return{set:function(b){a=b},clear:function(){a=null},get:function(){return a},viewerFields:b}};a.extend({dbFields:c()}),d=function(a){var b=a.serialize();return decodeURIComponent(b,!0)},func={getFormData:d},a.extend({func:func}),e=function(b){var c;return a.ajax({url:"/api/menuitem?parent="+b,method:"GET",async:!1,cache:!1,success:function(a){c=[!0,a]},error:function(a){c=[!1,a.responseJSON]}}),c},f=function(b){var c;return a.ajax({url:"/api/vieweritem?parent="+b,method:"GET",async:!1,cache:!1,success:function(a){c=[!0,a]},error:function(a){c=[!1,a.responseJSON]}}),c},api={getMenuItem:e,getViewerItem:f},a.extend({api:api}),g=function(b,c){var e,f,g,d=a.api.getMenuItem(c);if(d[0]){if(data=d[1],null==data.items)return;for(e="<option>选择父节点</option>\n",f=0;f<data.items.length;f++)e=e+'<option item-id="'+data.items[f].id+'">'+data.items[f].name+"</option>\n";g=a('<div class="alert alert-dismissable alert-danger"><button type="button" class="close" data-dismiss="alert">&times;</button><select class="custom-select parent-selector" onchange="$.selector.onParentSelected(this)" isselected="false">\n'+e+"</select></div>"),b.append(g)}else data=d[1],message(data.msg,"danger")},h=function(b){var e,f,c=0,d="";return b.length>0&&(e=b.last(),f=a(e.get(0)[e.get(0).selectedIndex]),c=f.attr("item-id"),d=e.val()),[c,d]},i=function(b){var c=a(b);c.get(0).selectedIndex>0?(c.parent().hasClass("alert-danger")&&(c.parent().removeClass("alert-danger"),c.parent().addClass("alert-success")),"false"==c.attr("isselected")&&c.attr("isselected",!0)):(c.parent().hasClass("alert-success")&&(c.parent().removeClass("alert-success"),c.parent().addClass("alert-danger")),"true"==c.attr("isselected")&&c.attr("isselected",!1))},j=function(b){for(var c=0;c<b.length;c++)if("false"==a(b[c]).attr("isselected"))return!0;return!1},k={createSelector:g,getSelectedParentID:h,onParentSelected:i,hasUnselectedSelector:j},a.extend({selector:k})}(jQuery);